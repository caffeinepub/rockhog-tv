{
  "kind": "build_request",
  "title": "Add per-stream live chat and viewer payment options for streamers",
  "projectName": "RockHog TV",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-53",
      "text": "Extend the backend Channel data type to include a dedicated chatRoomId field that associates each channel with its own chat room for live stream discussions",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ADD LIVE CHATROOM ON STREAMERS LIVE STREAMS"
        ]
      },
      "acceptanceCriteria": [
        "Channel type includes a chatRoomId field (type Text or ?Text)",
        "Existing channels remain readable after upgrade (migration handles the new field)",
        "When a new channel is created, a dedicated chat room is automatically created and its ID is stored in the channel's chatRoomId field"
      ]
    },
    {
      "id": "REQ-54",
      "text": "Update the backend createChannel method to automatically create a dedicated chat room for each new channel and store the chat room ID in the channel record",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ADD LIVE CHATROOM ON STREAMERS LIVE STREAMS"
        ]
      },
      "acceptanceCriteria": [
        "When a channel is created, a new chat room is created with a name derived from the channel title (e.g., 'Channel Title Chat')",
        "The chat room ID is stored in the channel's chatRoomId field",
        "The chat room is persisted in the chatRooms map"
      ]
    },
    {
      "id": "REQ-55",
      "text": "Add a StreamChatPanel component that embeds a live chat interface on the stream detail page, displaying messages from the channel's dedicated chat room and allowing authenticated users to post messages",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ADD LIVE CHATROOM ON STREAMERS LIVE STREAMS"
        ]
      },
      "acceptanceCriteria": [
        "StreamChatPanel component is created and accepts a chatRoomId prop",
        "Component reuses existing MessageList and ChatInput components for consistency",
        "Component fetches and displays messages for the specific chat room using useGetChatRoomMessages with polling enabled",
        "Authenticated users can post messages to the stream's chat room",
        "Component shows appropriate loading and error states"
      ]
    },
    {
      "id": "REQ-56",
      "text": "Integrate the StreamChatPanel component into the StreamDetailPage so it appears alongside the embedded stream player, creating a unified watch-and-chat experience",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ADD LIVE CHATROOM ON STREAMERS LIVE STREAMS"
        ]
      },
      "acceptanceCriteria": [
        "StreamChatPanel is rendered on the StreamDetailPage below or beside the StreamEmbed component",
        "The panel receives the channel's chatRoomId from the channel data",
        "Layout is responsive and works on both desktop and mobile viewports",
        "If the channel has no associated chat room, a fallback message is displayed"
      ]
    },
    {
      "id": "REQ-57",
      "text": "Add a StreamerPayment data type to the backend that stores payment transactions from viewers to streamers, including: payment ID, channel ID, sender principal, recipient principal, amount (in Bacon Cash), timestamp, and optional message",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "StreamerPayment type is defined with all required fields",
        "A persistent HashMap is created to store streamer payments by payment ID",
        "Payment records are immutable once created"
      ]
    },
    {
      "id": "REQ-58",
      "text": "Implement a backend sendTip method that transfers Bacon Cash from a viewer's balance to a streamer's balance, creates a payment record, and validates that the sender has sufficient funds",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "sendTip method accepts channelId, amount, and optional message as parameters",
        "Method verifies the sender is authenticated and has a user profile",
        "Method verifies the sender has sufficient Bacon Cash balance",
        "Method verifies the channel exists and retrieves the channel owner's principal",
        "Method deducts the amount from sender's balance and adds it to recipient's balance",
        "Method creates a StreamerPayment record with all transaction details",
        "Method returns success or error result"
      ]
    },
    {
      "id": "REQ-59",
      "text": "Add backend methods getPaymentsReceived and getPaymentsSent that allow users to query their payment history as either recipients or senders",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "getPaymentsReceived returns all payments where the caller is the recipient",
        "getPaymentsSent returns all payments where the caller is the sender",
        "Both methods require authentication",
        "Payments are returned sorted by timestamp (most recent first)"
      ]
    },
    {
      "id": "REQ-60",
      "text": "Create a React Query hook useSendTip that wraps the backend sendTip method and invalidates relevant queries (user balance, payment history) on success",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "useSendTip mutation hook is created in frontend/src/hooks/useQueries.ts",
        "Hook accepts channelId, amount, and optional message as parameters",
        "On success, invalidates user profile and payment history queries",
        "Hook returns loading, error, and success states"
      ]
    },
    {
      "id": "REQ-61",
      "text": "Create a React Query hook usePaymentHistory that fetches both received and sent payments for the authenticated user",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "usePaymentHistory hook is created in frontend/src/hooks/useQueries.ts",
        "Hook fetches both getPaymentsReceived and getPaymentsSent",
        "Hook is only enabled when user is authenticated",
        "Hook returns loading, error, and data states for both payment types"
      ]
    },
    {
      "id": "REQ-62",
      "text": "Add a TipDialog component that displays a modal form allowing viewers to send Bacon Cash tips to streamers, including amount input, optional message field, and current balance display",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "TipDialog component is created with shadcn Dialog composition",
        "Form includes a number input for tip amount (positive integers only)",
        "Form includes an optional textarea for a message to the streamer",
        "Current Bacon Cash balance is displayed prominently",
        "Form validates that amount does not exceed available balance",
        "Submit button triggers useSendTip mutation",
        "Success shows a toast notification and closes the dialog",
        "Error shows an error toast with the failure reason"
      ]
    },
    {
      "id": "REQ-63",
      "text": "Add a visible 'Send Tip' button to the StreamDetailPage that opens the TipDialog for authenticated viewers watching a stream",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "A 'Send Tip' or 'Tip Streamer' button is added to the StreamDetailPage near the channel metadata or chat panel",
        "Button is only visible to authenticated users who are not the channel owner",
        "Clicking the button opens the TipDialog with the current channel ID",
        "Button uses appropriate icon (e.g., DollarSign, Coins) and styling"
      ]
    },
    {
      "id": "REQ-64",
      "text": "Create a PaymentHistoryPage that displays the authenticated user's payment history in two tabs: 'Tips Received' and 'Tips Sent', showing transaction details including amount, channel, message, and timestamp",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "PaymentHistoryPage component is created with tabs for received and sent payments",
        "Each tab displays a list or table of payments with all relevant details",
        "Payment amounts are clearly displayed with Bacon Cash formatting",
        "Timestamps are formatted in a user-friendly way",
        "Empty state is shown when no payments exist in a tab",
        "Loading and error states are handled appropriately"
      ]
    },
    {
      "id": "REQ-65",
      "text": "Add a route for the payment history page at /payment-history in the application router and add a navigation entry point in the user account menu or Creator Studio area",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "ALL PAYMENT OPTIONS FOR LIVE STREAMERS TO GET PAID FROM THERE VIEWERS"
        ]
      },
      "acceptanceCriteria": [
        "Route /payment-history is added to the router configuration",
        "Route is protected and requires authentication",
        "A navigation link to 'Payment History' or 'Earnings' is added in an appropriate location (account menu, Creator Studio, or footer)",
        "Link is only visible to authenticated users"
      ]
    }
  ],
  "constraints": [
    "Do not modify the existing chat room architecture or ChatRoomPage component",
    "Reuse existing chat components (MessageList, ChatInput) for stream chat to maintain consistency",
    "Payment transactions must use the existing Bacon Cash system and balance fields",
    "All payment operations must validate sufficient balance before processing",
    "Stream chat must use the existing chat room polling mechanism (2.5s interval) for real-time updates"
  ],
  "nonGoals": [
    "External payment processing (Stripe, PayPal, etc.)",
    "Subscription tiers or recurring payments",
    "Payment withdrawal or cashout features",
    "Chat moderation tools (ban, mute, delete messages)",
    "Channel-specific chat permissions or roles",
    "Animated chat effects or emotes",
    "Payment notifications or alerts",
    "Leaderboards or top tippers displays"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}